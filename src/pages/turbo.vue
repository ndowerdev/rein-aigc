<script setup>
import axios from 'axios'
import { EventSourcePolyfill, NativeEventSource } from 'event-source-polyfill'

// import { useLoading } from 'vue-loading-overlay'

// Import stylesheet
// import 'vue-loading-overlay/dist/vue-loading.css'

import { usePreviewSettingsStore } from '~/stores/openai-preview-settings'

const fullPage = ref(true)
const previewSettings = usePreviewSettingsStore()
// const hasil = ref('')
const hasil = computed(() => {
  return previewSettings.settings.gptTurbo.lastResult ? previewSettings.settings.gptTurbo.lastResult.choices[0].message.content.trim() : ''
})
const realPrompt = computed(() => {
  return previewSettings.settings.prompt ? previewSettings.settings.prompt.replaceAll('{keyword}', previewSettings.settings.keyword).replaceAll('{language}', previewSettings.settings.language) : ''
})
const keyword = ref('')
const newMessage = ref({
  role: '',
  content: '',
})
useHead({
  title: 'ReinAIGC - OpenAI Content Generator - ReinAIGC',
  meta: [
    { name: 'description', content: 'Generate AI Content with custom prompt using your own OpenAI API Key' },

  ],
  link: [
    {
      rel: 'icon',
      type: 'image/svg+xml',
      href: '/favicon.svg',
    },
  ],
})
const roles = ref([
  {
    name: 'System',
    val: 'system',
  },
  {
    name: 'User',
    val: 'user',
  },
  {
    name: 'Assistant',
    val: 'assistant',
  },
])

const addThisMessage = () => {
  if (newMessage.value.content !== '' && newMessage.value.role !== '') {
    previewSettings.settings.gptTurbo.messages.push(newMessage.value)
    newMessage.value = {
      role: 'user',
      content: '',
    }
  }
}

const resx = ref('')
const isLoading = ref(false)
const removeThisMessage = (index) => {
  // formData.value.org.splice(formData.value.org.indexOf(index), 1)
  previewSettings.settings.gptTurbo.messages.splice(previewSettings.settings.gptTurbo.messages.indexOf(index), 1)
}
const visible = ref(false)

const formMessage = ref(previewSettings.settings.gptTurbo.messages.map((item) => {
  return {
    role: item.role,
    content: item.content.replaceAll('{keyword}', previewSettings.settings.gptTurbo.keyword).replaceAll('{language}', previewSettings.settings.gptTurbo.language),
  }
}))
const saveAndExecute = function () {
  isLoading.value = true

  const apiEndpoint = 'https://api.openai.com/v1/completions'

  axios({
    method: 'post',
    url: 'https://api.openai.com/v1/chat/completions',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${previewSettings.settings.apiKey}`,
    },
    data: {
      model: previewSettings.settings.gptTurbo.model,
      messages: formMessage.value,
      temperature: previewSettings.settings.gptTurbo.temperature,
      top_p: previewSettings.settings.gptTurbo.top_p,
      // stream: true,
      // temperature: parseFloat(previewSettings.settings.temperature),
      // max_tokens: parseFloat(previewSettings.settings.max_tokens),
    },
  }).then((response) => {
    isLoading.value = false
    previewSettings.settings.gptTurbo.lastResult = response.data
  })
}

watch(
  () => previewSettings.settings.gptTurbo.messages, (newVal, oldVal) => {
    // ip address input validation
    formMessage.value = newVal.map((item) => {
      return {
        role: item.role,
        content: item.content.replaceAll('{keyword}', previewSettings.settings.gptTurbo.keyword).replaceAll('{language}', previewSettings.settings.gptTurbo.language),
      }
    })
  },

  { deep: true },
)
</script>

<template>
  <ModalError v-if="isLoading === true" />
  <h2 class="text-xl text-center m-3 font-bold text-green-300">
    REIN AIGC - OpenAI Content Generator Online
  </h2>
  <div
    ref="formContainer"
    class="flex lg:flex-row-reverse flex-col-reverse  "
  >
    <div class="left w-full lg:w-1/2 text-white bg-leftcolor p-3 ">
      <div class="w-full ">
        <div class="flex flex-wrap ">
          <div class="w-full px-3  md:mb-0">
            <label
              class="block uppercase tracking-wide text-white text-lg font-bold mb-2"
              for="preview-html"
            >
              PREVIEW HTML
            </label>
            <textarea
              id="preview-html"
              v-model="hasil"
              rows="30"
              class="textarea textarea-primary w-full "
              placeholder="Loading..."
              disabled
            />
          </div>
        </div>
      </div>
    </div>
    <div class="right w-full lg:w-1/2 p-3">
      <div class="w-full max-w-xl p-3 m-auto">
        <div class="collapse collapse-open collapse-arrow border border-base-300 bg-base-100 rounded-box">
          <input type="checkbox">
          <div class="collapse-title text-xl font-medium">
            SETTINGS
          </div>

          <div class="collapse-content">
            <Divider title="API Settings" />
            <div class="flex flex-wrap -mx-3 m-3">
              <div class="w-full  px-3  md:mb-0">
                <input
                  id="api-key"
                  v-model="previewSettings.settings.apiKey"
                  class="input input-bordered  w-full"
                  type="text"
                  placeholder="Jane"
                >
              </div>
            </div>
            <div class="flex flex-wrap -mx-3 m-3">
              <div class="w-full  px-3  md:mb-0">
                <input
                  id="api-key"
                  v-model="previewSettings.settings.gptTurbo.keyword"
                  class="input input-bordered  w-full"
                  type="text"
                  placeholder="10 Alasan Cewek Mudah Marah"
                >
              </div>
            </div>
            <Divider title="Action" />
            <div class="flex flex-wrap -mx-3">
              <div class=" w-1/2 px-3">
                <button
                  class="btn w-full btn-success "
                  @click="saveAndExecute"
                >
                  ‚ñ∂Ô∏è Save & Execute
                </button>
              </div>
              <div class=" w-1/2 px-3">
                <button
                  class="btn w-full btn-warning "
                  @click="previewSettings.$reset003()"
                >
                  üîÑÔ∏è Reset
                </button>
              </div>
            </div>

            <Divider title="Add Parameters" />

            <div class="form-control">
              <div class="flex flex-col w-full gap-1">
                <select
                  v-model="newMessage.role"
                  class="select select-bordered w-full"
                >
                  <option value="" selected disabled hidden>
                    Choose Role
                  </option>
                  <option value="system">
                    System
                  </option>
                  <option value="user">
                    User
                  </option>
                  <option value="assistant">
                    Assistant
                  </option>
                </select>
                <textarea
                  v-model="newMessage.content"
                  type="text"
                  placeholder="Content"

                  class="textarea "
                />
                <button
                  class="btn "
                  @click="addThisMessage"
                >
                  ‚ûï Add
                </button>
              </div>
            </div>

            <div class="form-control ">
              <div
                v-for="(item, index) in previewSettings.settings.gptTurbo.messages"
                :key="index"
                class="flex-col w-full gap-1"
              >
                <Divider :title="`Parameter #${index + 1}`" />
                <select
                  v-model="item.role"
                  class="select select-bordered w-full mb-1"
                >
                  <option
                    v-for="(itemx, indexx) in roles"
                    :key="indexx"
                    :value="itemx.val"
                    :selected="itemx.val === item.role"
                  >
                    {{ itemx.name }}
                  </option>
                </select>
                <textarea
                  v-model="item.content"
                  type="text"
                  placeholder="Content"
                  class="textarea textarea-bordered w-full"
                  rows="5"
                />
                <button
                  class="btn w-full btn-outline btn-warning btn-sm"
                  @click="removeThisMessage(index)"
                >
                  ‚ùå delete
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style lang="scss" scoped></style>

<route lang="yaml">
name: openai-turbo
meta:
  layout: dashboard
</route>
